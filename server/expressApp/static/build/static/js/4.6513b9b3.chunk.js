(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{48:function(e,t,a){"use strict";a.r(t),a.d(t,"default",function(){return d});var r=a(32),n=a.n(r),s=a(37),o=a(33),c=a(2),i=a(3),h=a(36),l=a(35),u=a(34),d=function(){function e(){Object(c.a)(this,e),this.state=null,this.modelView=u.a.create(),this.opaqueMeshesInfo=[],this.transparentMeshesInfo=[],this.bookMeshInfo={},this.pbrMap=null,this.captureRenderTarget=null,this.canvas=null,this.programs={}}return Object(i.a)(e,[{key:"run",value:function(){var e=Object(o.a)(n.a.mark(function e(t){var a,r,o,c,i,d,p,g,m,T,w,F,_,E,M,f,R,I,A,B,x,L,v,b,C,N,G,P,D,U,O,y,S,k,V,j,H,Y,W,q,K,z,X,J,Q,Z,$,ee,te,ae,re,ne,se,oe,ce,ie,he,le=this;return n.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.canvas=t,e.next=3,(new h.d).load("./assets/model/lantern/lantern_obj.obj");case 3:return a=e.sent,e.next=6,(new l.a).load("./assets/textures/hdr/skybox.png",void 0,l.a.IMAGE);case 6:return r=e.sent,e.next=9,(new l.a).load("./assets/model/lantern/textures/lantern_Base_Color.jpg",void 0,l.a.IMAGE);case 9:return o=e.sent,e.next=12,(new l.a).load("./assets/model/lantern/textures/lantern_Mixed_AO.jpg",void 0,l.a.IMAGE);case 12:return c=e.sent,e.next=15,(new l.a).load("./assets/model/lantern/textures/lantern_Normal_OpenGL.jpg",void 0,l.a.IMAGE);case 15:return i=e.sent,e.next=18,(new l.a).load("./assets/model/lantern/textures/lantern_Metallic.jpg",void 0,l.a.IMAGE);case 18:return d=e.sent,e.next=21,(new l.a).load("./assets/model/lantern/textures/lantern_Roughness.jpg",void 0,l.a.IMAGE);case 21:for(p=e.sent,t.width=window.innerWidth,t.height=window.innerHeight,g=u.a.perspective(u.a.create(),Math.PI/2,1,.1,10),m=[u.a.lookAt(u.a.create(),u.c.set(u.c.create(),0,0,0),u.c.set(u.c.create(),1,0,0),u.c.set(u.c.create(),0,-1,0)),u.a.lookAt(u.a.create(),u.c.set(u.c.create(),0,0,0),u.c.set(u.c.create(),-1,0,0),u.c.set(u.c.create(),0,-1,0)),u.a.lookAt(u.a.create(),u.c.set(u.c.create(),0,0,0),u.c.set(u.c.create(),0,1,0),u.c.set(u.c.create(),0,0,1)),u.a.lookAt(u.a.create(),u.c.set(u.c.create(),0,0,0),u.c.set(u.c.create(),0,-1,0),u.c.set(u.c.create(),0,0,-1)),u.a.lookAt(u.a.create(),u.c.set(u.c.create(),0,0,0),u.c.set(u.c.create(),0,0,1),u.c.set(u.c.create(),0,-1,0)),u.a.lookAt(u.a.create(),u.c.set(u.c.create(),0,0,0),u.c.set(u.c.create(),0,0,-1),u.c.set(u.c.create(),0,-1,0))],T=u.a.perspective(u.a.create(),Math.PI/3,t.width/t.height,.1,400),w=u.a.lookAt(u.a.create(),u.c.set(u.c.create(),80,80,80),u.c.set(u.c.create(),0,50,0),u.c.set(u.c.create(),0,1,0)),F=[80,80,80],_=u.a.perspective(u.a.create(),Math.PI/2,t.width/t.height,.1,10),E=u.a.lookAt(u.a.create(),u.c.set(u.c.create(),0,0,.5),u.c.set(u.c.create(),0,0,0),u.c.set(u.c.create(),0,1,0)),M=new h.a,f=new h.g,R=new h.g(t.width/t.height,1),I=(new h.f).parse(new h.e,a),A=[u.c.set(u.c.create(),0,0,0),u.c.set(u.c.create(),-30,30,30),u.c.set(u.c.create(),30,30,30),u.c.set(u.c.create(),-30,-30,30),u.c.set(u.c.create(),30,-30,30)],B=[u.c.set(u.c.create(),2e4,2e3,0),u.c.set(u.c.create(),300,0,300),u.c.set(u.c.create(),300,0,300),u.c.set(u.c.create(),300,0,300),u.c.set(u.c.create(),300,0,300)],x=this.state=new h.o(t),(L=x.getContext()).getExtension("EXT_color_buffer_float"),L.enable(L.CULL_FACE),L.cullFace(L.FRONT),v=x.createVaoFromGeometry(M),b=x.createVaoFromGeometry(f),C=x.createVaoFromGeometry(R),I.children.forEach(function(e,t){var a={vao:x.createVaoFromGeometry(e.geometry),indexLen:e.geometry.attributes.position.data.length/3};"glass lantern"!==e.name?le.opaqueMeshesInfo.push(a):le.transparentMeshesInfo.push(a)}),N=this.captureRenderTarget=x.createRenderTarget(512,512),L.pixelStorei(L.UNPACK_FLIP_Y_WEBGL,!0),G=x.createTexture2D({image:o,width:2048,height:2048,internalFormat:L.RGB,format:L.RGB,type:L.UNSIGNED_BYTE}),L.pixelStorei(L.UNPACK_FLIP_Y_WEBGL,!0),P=x.createTexture2D({image:c,width:1,height:1,internalFormat:L.LUMINANCE,format:L.LUMINANCE,type:L.UNSIGNED_BYTE}),L.pixelStorei(L.UNPACK_FLIP_Y_WEBGL,!0),D=x.createTexture2D({image:i,internalFormat:L.RGB,format:L.RGB,type:L.UNSIGNED_BYTE}),L.pixelStorei(L.UNPACK_FLIP_Y_WEBGL,!0),U=x.createTexture2D({image:d,width:1,height:1,internalFormat:L.LUMINANCE,format:L.LUMINANCE,type:L.UNSIGNED_BYTE}),L.pixelStorei(L.UNPACK_FLIP_Y_WEBGL,!0),O=x.createTexture2D({image:p,width:1,height:1,internalFormat:L.LUMINANCE,format:L.LUMINANCE,type:L.UNSIGNED_BYTE}),y=x.createTexture2D({image:r,internalFormat:L.RGBA16F,format:L.RGBA,type:L.FLOAT}),S=x.createTextureCube({internalFormat:L.RGBA16F,format:L.RGBA,type:L.FLOAT,width:512,height:512,minF:L.LINEAR_MIPMAP_LINEAR}),k=x.createTextureCube({internalFormat:L.RGBA16F,format:L.RGBA,type:L.FLOAT,width:32,height:32}),V=x.createTextureCube({internalFormat:L.RGBA16F,format:L.RGBA,type:L.FLOAT,width:128,height:128,minF:L.LINEAR_MIPMAP_LINEAR,levels:5}),j=x.createTexture2D({internalFormat:L.RG16F,format:L.RG,type:L.FLOAT,width:512,height:512}),H=this.pbrMap=x.createTexture2D({internalFormat:L.RGBA16F,format:L.RGBA,type:L.FLOAT,width:t.width,height:t.height}),Y=h.i.pbr,W=h.i.brdf,q=h.i.prefilter,K=h.i.convert_2d_to_cubemap,z=h.i.irradiance_convolution,X=h.i.book,J=x.createProgramInfo(Y.vs.getSource(),Y.fs.addDefine("NORMAL_MAP").addDefine("POINT_LIGHT_NUMBER",5).getSource()),Q=x.createProgramInfo(W.vs.getSource(),W.fs.getSource()),Z=x.createProgramInfo(q.vs.getSource(),q.fs.getSource()),$=x.createProgramInfo(K.vs.getSource(),K.fs.getSource()),ee=x.createProgramInfo(z.vs.getSource(),z.fs.getSource()),te=x.createProgramInfo(X.vs.getSource(),X.fs.getSource()),x.enableDepthTest(L.DEPTH_TEST),x.setClearColor(0,0,0,1),x.viewport(0,0,512,512),x.use($.program),x.setMat4("projection",g),x.setTexture2D("equirectangularMap",y,0),x.setVao(v),ae=0;ae<6;++ae)x.setCubeRenderTarget(N,S,ae),x.setMat4("view",m[ae]),x.clear(L.COLOR_BUFFER_BIT|L.DEPTH_BUFFER_BIT),x.drawElements(36);for(x.generateMipmap(L.TEXTURE_CUBE_MAP,S),x.unBindRenderTarget(),x.use(ee.program),x.viewport(0,0,32,32),x.setMat4("projection",g),x.setTextureCube("environmentMap",S,0,!0),x.setVao(v),x.resizeRenderTarget(N,32,32),x.clear(L.COLOR_BUFFER_BIT|L.DEPTH_BUFFER_BIT),re=0;re<6;++re)x.setMat4("view",m[re]),x.setCubeRenderTarget(N,k,re),x.drawElements(36);for(x.unBindRenderTarget(),x.use(Z.program),x.setMat4("projection",g),x.setVao(v),5,ne=0;ne<5;++ne)for(se=128*Math.pow(.5,ne),oe=128*Math.pow(.5,ne),ce=ne/4,x.viewport(0,0,se,oe),x.resizeRenderTarget(N,se,oe),x.setFloat("roughness",ce),ie=0;ie<6;++ie)x.setMat4("view",m[ie]),x.setTextureCube("environmentMap",S,0,!0),x.setCubeRenderTarget(N,V,ie,ne),x.clear(L.COLOR_BUFFER_BIT|L.DEPTH_BUFFER_BIT),x.drawElements(36);for(x.unBindRenderTarget(),L.cullFace(L.BACK),x.use(Q.program),x.viewport(0,0,512,512),x.setVao(b),x.resizeRenderTarget(N,512,512),x.setRenderTarget(N,j),x.clear(L.COLOR_BUFFER_BIT|L.DEPTH_BUFFER_BIT),x.drawElements(f.indices.data.length),x.unBindRenderTarget(),L.disable(L.CULL_FACE),x.use(J.program),x.viewport(0,0,t.width,t.height),x.setMat4("projection",T),x.setMat4("view",w),x.setVec3.apply(x,["camPos"].concat(F)),x.setFloat("opacity",1),x.setTextureCube("irradianceMap",k,0),x.setTextureCube("prefilterMap",V,1),x.setTexture2D("brdfLUT",j,2),x.setTexture2D("albedoMap",G,3),x.setTexture2D("normalMap",D,4),x.setTexture2D("aoMap",P,5),x.setTexture2D("metallicMap",U,6),x.setTexture2D("roughnessMap",O,7),x.setMat4("model",u.a.create()),x.clear(L.COLOR_BUFFER_BIT|L.DEPTH_BUFFER_BIT),he=0;he<A.length;++he)x.setVec3.apply(x,["pointLightPositions["+he+"]"].concat(Object(s.a)(A[he]))),x.setVec3.apply(x,["pointLightColors["+he+"]"].concat(Object(s.a)(B[he])));x.viewport(0,0,t.width,t.height),x.use(te.program),x.setMat4("view",E),x.setMat4("projection",_),x.setMat4("model",u.a.create()),x.setFloat("ratio",R.width/R.height),x.setFloat("iTime",(new Date).getTime()),x.setFloat("width",R.width),x.setFloat("height",R.height),x.setTexture2D("iChannel0",y,0),x.setTexture2D("iChannel1",H,1),x.setFloat("ratio",R.width/R.height),x.setVec2("mouse",.001,.001),this.bookMeshInfo={vao:C,indexLen:R.indices.data.length},this.programs={pbr:J.program,book:te.program},window.addEventListener("mousemove",function(e){x.setVec2("mouse",Math.max(e.clientX*R.width/window.innerWidth,.001),(1-e.clientY/window.innerHeight)*R.height)}),this.animate();case 133:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"animate",value:function(){var e=this.state,t=e.getContext();this.canvas&&(e.use(this.programs.pbr),e.resizeRenderTarget(this.captureRenderTarget,this.canvas.width,this.canvas.height),e.setRenderTarget(this.captureRenderTarget,this.pbrMap),e.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),u.a.rotate(this.modelView,this.modelView,Math.PI/180,[0,1,0]),e.setMat4("model",this.modelView),this.opaqueMeshesInfo.forEach(function(a){t.disable(t.BLEND),e.setVao(a.vao),e.setFloat("opacity",1),e.drawArray(a.indexLen)}),this.transparentMeshesInfo.forEach(function(a){t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE),t.cullFace(t.FRONT),e.setVao(a.vao),e.setFloat("opacity",.8),e.drawArray(a.indexLen)}),e.unBindRenderTarget(),e.use(this.programs.book),e.setVao(this.bookMeshInfo.vao),e.drawElements(this.bookMeshInfo.indexLen),requestAnimationFrame(this.animate.bind(this)))}}]),e}()}}]);